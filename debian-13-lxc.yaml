# Debian 13 (Trixie) LXC custom image for Proxmox VE
# Build: distrobuilder build-lxc debian-13-lxc.yaml

image:
  distribution: debian
  release: trixie
  architecture: amd64
  description: Debian 13 (Trixie) LXC Custom
  name: debian-13-lxc-custom-{{image.architecture}}-{{image.serial}}
  serial: "{{ image.serial }}"

source:
  downloader: debootstrap
  url: https://deb.debian.org/debian
  keyserver: keyserver.ubuntu.com
  keys:
    - "0x04B54C3CDCA79751B16BC6B5225629DF75B188BD" # Debian Archive Signing Key (13/trixie)
    - "0x5E04A1E3223A19A20706E20F9904613D4CCE68C6" # Debian Security Archive Signing Key (13/trixie)
    - "0x41587F7DB8C774BCCF131416762F67A0B2C39DE4" # Debian Release Key (13/trixie)

targets:
  lxc:
    create_message: |
      Debian 13 (Trixie) LXC Custom Image

    config:
      - type: all
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/debian.common.conf

      - type: user
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/debian.userns.conf

      - type: all
        content: |-
          lxc.arch = {{ image.architecture_personality }}

packages:
  manager: apt
  update: true
  cleanup: true

  sets:
    - packages:
        - vim
        - zsh
        - tree
        - curl
        - wget
        - ufw
        - zstd
        - zip
        - unzip
        - locales
        - rsync
        - openssh-server
      action: install

  repositories:
    - name: sources.list.d/debian.sources
      url: |-
        Types: deb
        URIs: https://deb.debian.org/debian
        Suites: trixie trixie-updates trixie-backports
        Components: main contrib non-free non-free-firmware
        Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

        Types: deb
        URIs: https://deb.debian.org/debian-security
        Suites: trixie-security
        Components: main contrib non-free non-free-firmware
        Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

actions:
  # Replace mirrors with USTC
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list.d/debian.sources

  # Timezone
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
      echo "Asia/Shanghai" > /etc/timezone

  # Locale
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      sed -i '/^#.*en_US.UTF-8 UTF-8/s/^#//' /etc/locale.gen
      sed -i '/^#.*zh_CN.UTF-8 UTF-8/s/^#//' /etc/locale.gen
      locale-gen
      echo 'LANG=en_US.UTF-8' > /etc/default/locale

  # SSH
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      sed -i '/^#\?MaxAuthTries[[:space:]]/c\MaxAuthTries 15' /etc/ssh/sshd_config
      systemctl enable ssh || true

  # Login banner with IP address
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      echo "IPv4: \\4" >> /etc/issue

  # Cleanup
  - trigger: post-packages
    action: |-
      #!/bin/bash
      set -eux
      apt-get -y autoremove --purge
      apt-get -y clean
      rm -rf /var/lib/apt/lists/*
      rm -rf /var/cache/apt/*
      rm -rf /var/log/*.log
      rm -rf /tmp/*
      rm -f /etc/ssh/ssh_host_*
      truncate -s 0 /etc/machine-id || true

mappings:
  architecture_map: debian
